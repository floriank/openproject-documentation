                            <h1>OpenProject 3.0 to OpenProject 4.0 Debian/Ubuntu Upgrade Guide</h1>
<p>This guide describes the upgrade process from OpenProject 3.0 to 4.0 on Debian 7.7 and Ubuntu 14.04 LTS step by step.<br />
Note: We strongly recommend to update your OpenProject installation to the latest available 3.0 version (currently 3.0.14), before attempting an update to 4.0.</p>
<p>&nbsp;</p>
<h2>1. Preparation</h2>
<ul>
<li>Before Updating, check that all the installed OpenProject plugins support the new OpenProject Version. Remove incompatible plugins before attempting an upgrade.</li>
<li>Stop the OpenProject Server. You may even add a maintenance page, if you feel comfortable with that (for example using the approach taken in<a class="external" href="http://blog.flowdock.com/2009/03/11/stopping-your-rails-application-with-phusion-passenger/"> this blog post</a>)</li>
<li>Please <a class="wiki-page" title="Backup Guide" href="/download/backup-guide/">do a backup</a></li>
<li>Stop the (delayed_job) worker process.<br />
If you run the worker process with a cronjob, disable the cronjob temporarily.<br />
In case you run the woker process through <code>RAILS_ENV=production bundle exec script/delayed_job start</code>, execute the following:</li>
</ul>
<pre class="">RAILS_ENV=production bundle exec script/delayed_job stop</pre>
<p>Update your system:</p>
<pre class="">[root@debian]# apt-get update
[root@debian]# apt-get upgrade</pre>
<h2>2. Get the new OpenProject Source Code</h2>
<p>Change into the directory where OpenProject was installed as the operating-system-user OpenProject runs as. We assume that OpenProject is installed in <code>/home/openproject/openproject</code> by the <code>openproject</code> user.</p>
<pre>[root@debian]# su - openproject -c "bash -l"
[openproject@debian]# cd ~/openproject/openproject
</pre>
<p>Remove manual changes and modifications (If you have modified OpenProject source files and want to preserve those changes, back up your changes, and re-apply them later):</p>
<pre class="">[openproject@debian]# git reset --hard
[openproject@debian]# git checkout stable
[openproject@debian]# git pull</pre>
<h2>3. Upgrade Ruby</h2>
<p>OpenProject 4.0 requires Ruby to be installed in version 2.1.x. Assuming you have installed Ruby via <a class="external" href="https://rvm.io/">RVM</a>, do the following to upgrade your Ruby installation:</p>
<pre class="">[openproject@debian]# rvm get stable
[openproject@debian]# export -f rvm_debug
[openproject@debian]# rvm install 2.1.4
[openproject@debian]# rvm use --default 2.1.4
[openproject@debian]# gem install bundler
[openproject@debian]# bundle install</pre>
<h2>4. Node.js installation</h2>
<p>The major change from OpenProject 3.0 to 4.0 (when looking at the system requirements and installation) is how the assets (JavaScript and CSS) are precompiled. The precompilation step needs Node.js now.<br />
We will install the latest 0.10.x version of Node.js via <a class="external" href="https://pypi.python.org/pypi/nodeenv">nodeenv</a> :</p>
<pre>[openproject@debian]# exit
[root@debian]# apt-get install python python-pip
[root@debian]# pip install nodeenv
[root@debian]# su - openproject -c "bash -l"
[openproject@debian]# cd /home/openproject
[openproject@debian]# nodeenv nodeenv
[openproject@debian]# source ./nodeenv/bin/activate
[openproject@debian]# npm -g install bower
</pre>
<p>As a reference, the following Node.js and NPM versions have been installed on our system:</p>
<pre class="">[openproject@debian]# node --version
                      v0.10.32
[openproject@debian]# npm --version
                      1.4.28
[openproject@debian]# bower --version
                      1.3.12</pre>
<h2>5. The Upgrade</h2>
<p>Now that the sources and dependencies are in place, you can migrate the Database and do the upgrade:</p>
<pre class="">[openproject@debian]# cd /home/openproject/openproject
[openproject@debian]# npm install
[openproject@debian]# bower install
[openproject@debian]# RAILS_ENV="production" bundle exec rake db:migrate
[openproject@debian]# RAILS_ENV="production" bundle exec rake db:seed
[openproject@debian]# RAILS_ENV="production" bundle exec rake assets:precompile
[openproject@debian]# touch tmp/restart.txt</pre>
<h2>6. Serving OpenProject</h2>
<p>This sections only applies to you, if you serve OpenProject via Apache and Passenger. If you serve OpenProject in a different way, be sure to check that it still works.</p>
<p>During the 3.0 installation, we have set-up Passenger in the Apache configuration files. During the OpenProject upgrade, we have potentially installed a new Ruby and Passenger Version. The versions of Ruby and Passenger appear in the Apache configuration like this:</p>
<pre>LoadModule passenger_module /home/openproject/.rvm/gems/ruby-2.1.4/gems/passenger-4.0.53/buildout/apache2/mod_passenger.so
&lt;IfModule mod_passenger.c&gt;
  PassengerRoot /home/openproject/.rvm/gems/ruby-2.1.4/gems/passenger-4.0.53
  PassengerDefaultRuby /home/openproject/.rvm/gems/ruby-2.1.4/wrappers/ruby
&lt;/IfModule&gt;
</pre>
<p>Please run the following commands to upgrade passenger and re-install the Apache module:</p>
<pre>[openproject@debian]# gem update passenger
[openproject@debian]# gem cleanup passenger
[openproject@debian]# passenger-install-apache2-module
</pre>
<p>The output of <code>passenger-install-apache2-module2</code> tells you how to configure Apache.<br />
It is basically the same as what is already installed, except for the updated version numbers.</p>
<p>Don&#8217;t forget to restart apache after the configuration change:</p>
<pre class="">[root@debian]# service apache2 reload</pre>
<h2>7. The Aftermath</h2>
<ul>
<li>Re-enable the <code>delayed_job</code> cron job that was disabled in the first step.</li>
<li>If you have put up a maintenance page, remove it.</li>
<li>Start the OpenProject server again</li>
<li>Watch for further OpenProject updates in our <a class="external" href="https://community.openproject.org/projects/openproject/news">news</a>, or on <a class="external" href="https://twitter.com/openproject">twitter</a>.</li>
</ul>
<h2>8. Questions, Comments, and Feedback</h2>
<p>If you have any further questions, comments, feedback, or an idea to enhance this guide, please tell us at the appropriate <a class="external" href="https://community.openproject.org/projects/openproject/boards/9">forum</a>.</p>
<p>Also, please take a look at the <a title="Upgrading to the Current Version Questions" href="https://www.openproject.org/help/faq/upgrading-current-version-questions/">Frequently Asked Questions</a>.</p>
